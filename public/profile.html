<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Management - NaTeSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .sky-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 50%, #7dd3fc 100%);
        }
        .profile-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .upload-area {
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            transform: scale(1.02);
        }
        .floating-label {
            transition: all 0.2s ease;
        }
        .input-focused .floating-label {
            transform: translateY(-1.5rem) scale(0.875);
            color: #0ea5e9;
        }
        .profile-picture {
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2);
        }
    </style>
</head>
<body class="min-h-screen sky-gradient">
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-white">Profile Management</h1>
                        <p class="text-sm text-sky-100">Manage your NaTeSA account</p>
                    </div>
                </div>
                <button onclick="goBack()" class="text-white hover:text-sky-100 transition-colors">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="profile-card rounded-2xl shadow-xl p-6 text-center">
                    <div class="relative inline-block mb-6">
                        <div class="profile-picture w-32 h-32 rounded-full mx-auto overflow-hidden bg-gradient-to-br from-sky-400 to-sky-600 flex items-center justify-center relative">
                            <img id="profileImage" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <div id="profileInitials" class="text-3xl font-bold text-white">LD</div>
                        </div>
                        <button id="editPhotoBtn" class="absolute bottom-0 right-0 bg-sky-500 hover:bg-sky-600 text-white p-2 rounded-full shadow-lg transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <input type="file" id="photoInput" accept="image/*" class="hidden">
                    </div>
                    
                    <h2 id="profileName" class="text-xl font-semibold text-gray-900 mb-2">Loading...</h2>
                    <p id="profileEmail" class="text-sky-600 mb-4">Loading...</p>
                    
                    <div class="space-y-3">
                        <div class="bg-gradient-to-r from-sky-50 to-sky-100 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700">BEC Member</span>
                                <span id="becStatus" class="px-2 py-1 bg-gray-400 text-white text-xs rounded-full">No</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-sky-50 to-sky-100 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-700 mb-1">NEC Position</div>
                            <div id="necPosition" class="text-sm text-sky-600 font-medium">None</div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-sky-50 to-sky-100 rounded-lg p-3">
                            <div class="text-sm font-medium text-gray-700 mb-1">BEC Position</div>
                            <div id="becPosition" class="text-sm text-sky-600 font-medium">None</div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-sky-50 to-sky-100 rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700">Account Status</span>
                                <span id="accountStatus" class="px-2 py-1 bg-gray-400 text-white text-xs rounded-full">Loading</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="profile-card rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Personal Information</h3>
                        <button id="editToggle" class="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            <span>Edit Profile</span>
                        </button>
                    </div>

                    <form id="profileForm" class="space-y-6">
                        <div class="relative">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    id="name" 
                                    name="name" 
                                    disabled
                                    class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                    placeholder=" "
                                >
                                <label for="name" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none">Full Name</label>
                            </div>
                        </div>

                        <div class="relative">
                            <div class="input-group">
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    disabled
                                    class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                    placeholder=" "
                                >
                                <label for="email" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none">Email Address</label>
                            </div>
                        </div>

                        <div class="relative">
                            <div class="input-group">
                                <select 
                                    id="branch_id" 
                                    name="branch_id" 
                                    disabled
                                    class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                >
                                    <option value="">Loading branches...</option>
                                </select>
                                <label for="branch_id" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none transform -translate-y-6 scale-75">Branch</label>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h4>
                            
                            <div class="space-y-4">
                                <div class="relative">
                                    <div class="input-group">
                                        <input 
                                            type="password" 
                                            id="currentPassword" 
                                            name="currentPassword" 
                                            disabled
                                            class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                            placeholder=" "
                                        >
                                        <label for="currentPassword" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none">Current Password</label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="relative">
                                        <div class="input-group">
                                            <input 
                                                type="password" 
                                                id="newPassword" 
                                                name="newPassword" 
                                                disabled
                                                class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                                placeholder=" "
                                            >
                                            <label for="newPassword" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none">New Password</label>
                                        </div>
                                    </div>

                                    <div class="relative">
                                        <div class="input-group">
                                            <input 
                                                type="password" 
                                                id="confirmPassword" 
                                                name="confirmPassword" 
                                                disabled
                                                class="w-full px-4 py-3 border-2 border-sky-200 rounded-lg focus:border-sky-500 focus:outline-none transition-colors bg-white disabled:bg-gray-50 disabled:text-gray-500"
                                                placeholder=" "
                                            >
                                            <label for="confirmPassword" class="floating-label absolute left-4 top-3 text-gray-500 pointer-events-none">Confirm Password</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="actionButtons" class="flex justify-end space-x-4 pt-6 hidden">
                            <button 
                                type="button" 
                                id="cancelBtn"
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit" 
                                class="px-6 py-3 bg-gradient-to-r from-sky-500 to-sky-600 text-white rounded-lg hover:from-sky-600 hover:to-sky-700 transition-all shadow-lg hover:shadow-xl"
                            >
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>

                <div class="profile-card rounded-2xl shadow-xl p-8 mt-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Recent Activity</h3>
                    <div class="space-y-4" id="activityLog">
                        <div class="flex items-center space-x-4 p-4 bg-sky-50 rounded-lg">
                            <div class="h-10 w-10 bg-sky-500 rounded-full flex items-center justify-center">
                                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">Profile loaded</p>
                                <p class="text-xs text-gray-500">Your profile information has been loaded</p>
                            </div>
                            <span class="text-xs text-gray-400">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="successMessage" class="fixed top-4 right-4 bg-white rounded-lg shadow-xl p-4 transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-3">
            <div class="h-8 w-8 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-900">Profile Updated!</p>
                <p class="text-xs text-gray-500">Your changes have been saved successfully.</p>
            </div>
        </div>
    </div>

    <script>
        var API_BASE = '/api';
        var currentUser = JSON.parse(localStorage.getItem('currentUser'));
        var branchesData = [];
        var originalUserData = {};
        var isEditing = false;

        function goBack() {
            window.history.back();
        }

        function initializeProfile() {
            if (!currentUser || !currentUser.id) {
                alert('Please sign in first');
                window.location.href = 'signin.html';
                return;
            }

            loadUserData();
            loadBranches();
            initFloatingLabels();
            initPhotoUpload();
            setupEventListeners();
        }

        function loadUserData() {
            fetch(API_BASE + '/users/' + currentUser.id)
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to load user data');
                    return response.json();
                })
                .then(function(user) {
                    currentUser = user;
                    originalUserData = JSON.parse(JSON.stringify(user));
                    updateProfileDisplay();
                    addActivityLog('Profile information loaded successfully');
                })
                .catch(function(error) {
                    console.error('Error loading user:', error);
                    addActivityLog('Error loading profile data', 'error');
                });
        }

        function loadBranches() {
            fetch(API_BASE + '/branches')
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to load branches');
                    return response.json();
                })
                .then(function(branches) {
                    branchesData = branches;
                    populateBranchDropdown();
                })
                .catch(function(error) {
                    console.error('Error loading branches:', error);
                });
        }

        function updateProfileDisplay() {
            document.getElementById('profileName').textContent = currentUser.name || 'Unknown';
            document.getElementById('profileEmail').textContent = currentUser.email || 'No email';
            document.getElementById('profileInitials').textContent = getInitials(currentUser.name);
            
            document.getElementById('name').value = currentUser.name || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('branch_id').value = currentUser.branch_id || '';
            
            document.getElementById('becStatus').textContent = currentUser.is_bec_member ? 'Yes' : 'No';
            document.getElementById('becStatus').className = currentUser.is_bec_member 
                ? 'px-2 py-1 bg-sky-500 text-white text-xs rounded-full'
                : 'px-2 py-1 bg-gray-400 text-white text-xs rounded-full';
            
            document.getElementById('necPosition').textContent = currentUser.nec_position || 'None';
            document.getElementById('becPosition').textContent = currentUser.bec_position || 'None';
            
            var statusElement = document.getElementById('accountStatus');
            statusElement.textContent = currentUser.status ? currentUser.status.charAt(0).toUpperCase() + currentUser.status.slice(1) : 'Unknown';
            statusElement.className = currentUser.status === 'active' 
                ? 'px-2 py-1 bg-green-500 text-white text-xs rounded-full'
                : 'px-2 py-1 bg-red-500 text-white text-xs rounded-full';

            updateFloatingLabels();
        }

        function getInitials(name) {
            if (!name) return '??';
            return name.split(' ').map(function(word) { 
                return word[0]; 
            }).join('').toUpperCase().substring(0, 2);
        }

        function populateBranchDropdown() {
            var dropdown = document.getElementById('branch_id');
            dropdown.innerHTML = '<option value="">Select Branch</option>';
            
            branchesData.forEach(function(branch) {
                var option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.name + ' - ' + branch.university;
                option.selected = branch.id === currentUser.branch_id;
                dropdown.appendChild(option);
            });
        }

        function initFloatingLabels() {
            var inputs = document.querySelectorAll('input, select');
            
            inputs.forEach(function(input) {
                var updateLabel = function() {
                    var group = input.closest('.input-group');
                    if (!group) return;
                    
                    if (input.value || input === document.activeElement) {
                        group.classList.add('input-focused');
                    } else {
                        group.classList.remove('input-focused');
                    }
                };
                
                input.addEventListener('focus', updateLabel);
                input.addEventListener('blur', updateLabel);
                input.addEventListener('input', updateLabel);
            });
        }

        function updateFloatingLabels() {
            var inputs = document.querySelectorAll('input, select');
            inputs.forEach(function(input) {
                var group = input.closest('.input-group');
                if (input.value) {
                    group.classList.add('input-focused');
                }
            });
        }

        function initPhotoUpload() {
            var editPhotoBtn = document.getElementById('editPhotoBtn');
            var photoInput = document.getElementById('photoInput');
            var profileImage = document.getElementById('profileImage');
            var profileInitials = document.getElementById('profileInitials');
            
            if (editPhotoBtn && photoInput) {
                editPhotoBtn.addEventListener('click', function() {
                    photoInput.click();
                });
                
                photoInput.addEventListener('change', function(e) {
                    var file = e.target.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            profileImage.src = e.target.result;
                            profileImage.classList.remove('hidden');
                            profileInitials.classList.add('hidden');
                            addActivityLog('Profile picture updated');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        function setupEventListeners() {
            var editToggle = document.getElementById('editToggle');
            var cancelBtn = document.getElementById('cancelBtn');
            var profileForm = document.getElementById('profileForm');
            
            if (editToggle) {
                editToggle.addEventListener('click', toggleEditMode);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', toggleEditMode);
            }
            
            if (profileForm) {
                profileForm.addEventListener('submit', handleFormSubmit);
            }
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            var editButton = document.getElementById('editToggle');
            var actionButtons = document.getElementById('actionButtons');
            var inputs = document.querySelectorAll('#profileForm input, #profileForm select');
            
            if (isEditing) {
                editButton.innerHTML = `
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span>Cancel Edit</span>
                `;
                editButton.className = 'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2';
                actionButtons.classList.remove('hidden');
                
                inputs.forEach(function(input) {
                    if (['name', 'email', 'branch_id', 'currentPassword', 'newPassword', 'confirmPassword'].includes(input.name)) {
                        input.disabled = false;
                        input.classList.remove('disabled:bg-gray-50', 'disabled:text-gray-500');
                    }
                });
            } else {
                editButton.innerHTML = `
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    <span>Edit Profile</span>
                `;
                editButton.className = 'bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2';
                actionButtons.classList.add('hidden');
                
                inputs.forEach(function(input) {
                    input.disabled = true;
                    input.classList.add('disabled:bg-gray-50', 'disabled:text-gray-500');
                });
                
                resetFormToOriginal();
                clearPasswordFields();
            }
        }

        function resetFormToOriginal() {
            document.getElementById('name').value = originalUserData.name || '';
            document.getElementById('email').value = originalUserData.email || '';
            document.getElementById('branch_id').value = originalUserData.branch_id || '';
            updateProfileDisplay();
        }

        function clearPasswordFields() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            var formData = new FormData(e.target);
            var newPassword = formData.get('newPassword');
            var confirmPassword = formData.get('confirmPassword');
            var currentPassword = formData.get('currentPassword');
            
            if (newPassword && newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            if ((newPassword || currentPassword) && !(newPassword && currentPassword)) {
                alert('Please fill both current and new password fields to change password.');
                return;
            }
            
            var updateData = {
                name: formData.get('name'),
                email: formData.get('email'),
                branch_id: parseInt(formData.get('branch_id'))
            };
            
            if (newPassword && currentPassword) {
                updateData.currentPassword = currentPassword;
                updateData.newPassword = newPassword;
            }
            
            fetch(API_BASE + '/users/' + currentUser.id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to update profile');
                return response.json();
            })
            .then(function(updatedUser) {
                currentUser = updatedUser;
                originalUserData = JSON.parse(JSON.stringify(updatedUser));
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                
                updateProfileDisplay();
                toggleEditMode();
                clearPasswordFields();
                showSuccessMessage();
                addActivityLog('Profile updated successfully');
            })
            .catch(function(error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile: ' + error.message);
                addActivityLog('Failed to update profile', 'error');
            });
        }

        function showSuccessMessage() {
            var message = document.getElementById('successMessage');
            message.classList.remove('translate-x-full');
            message.classList.add('translate-x-0');
            
            setTimeout(function() {
                message.classList.remove('translate-x-0');
                message.classList.add('translate-x-full');
            }, 3000);
        }

        function addActivityLog(message, type) {
            var activityLog = document.getElementById('activityLog');
            var iconColor = type === 'error' ? 'bg-red-500' : 'bg-sky-500';
            var icon = type === 'error' ? 
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' :
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
            
            var logEntry = document.createElement('div');
            logEntry.className = 'flex items-center space-x-4 p-4 bg-sky-50 rounded-lg';
            logEntry.innerHTML = `
                <div class="h-10 w-10 ${iconColor} rounded-full flex items-center justify-center">
                    <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${icon}
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">${message}</p>
                    <p class="text-xs text-gray-500">Profile management activity</p>
                </div>
                <span class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</span>
            `;
            
            activityLog.insertBefore(logEntry, activityLog.firstChild);
            
            if (activityLog.children.length > 5) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeProfile);
    </script>
</body>
</html>